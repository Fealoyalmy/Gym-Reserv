# 前置准备
1. 本人的运行环境是 python 3.11.5，建议使用相同或以上版本
2. 拉取代码后，使用`pip install -r requirements.txt`安装所需库
3. 在手机上安装`Reqable`，用于抓包（关于该软件的使用，可参考官方文档：https://reqable.com/zh-CN/）
4. 登录`i-南航`后，开启`Reqable`的抓包功能，随后在`i-南航`中进入预约界面或随便点几个其他的按钮即可停止抓包了（安卓手机可能需要手动确认信任证书；ios可能出现证书无法验证的问题，建议在电脑端开`wireshark`，让手机电脑连同一局域网，通过走代理的方式来抓包）
5. 查看抓包记录中域名为 https://ehall3.nuaa.edu.cn 的请求中的`cookie`值（有效的`cookie`格式参考配置文件中写的两个`cookie`，你抓到的`cookie`跟这个长的差不多就没问题，有的账号的`cookie`可能有些字段没有，这个没有影响，直接copy来用即可），`GET`、`POST`请求均可，`CONNECT`请求是信任证书时的无效请求，忽略即可
   
# 使用说明
1. 所有配置只需在`config.yaml`中进行即可，无需修改代码
2. `header`中的`user-agent`可以不用调整，但建议自行抓包后改为自己的设备信息（以防系统日志检测发现与你i南航上的设备信息不一致）
3. `captcha`中填写的是我的打码账户，里面现在只有60多积分，预计还能进行一百次左右的打码操作。建议自己前往打码网站创建一个账户来使用，充值1元可以打码150次（打码网站：https://tulingtech.xyz/#/itemPage）
4. 配置中无需设置具体日期与时间，代码逻辑为自动获取当天日期，并在07:00:02准时执行预约
5. 预约配置默认为`2号场地的19:00-20:00`与`2号场地的20:00-21:00`，如果脚本执行期间预设的场次没抢到，重试过程中会在同一时间段中轮询去抢其他场地号（即2号没抢到就抢3号，还没抢到就抢4号...直到成功或超过最大重试次数）
6. 想要自定义预约场次的可以看参数说明中的例子来自行调整时间段id与场次id
7. 修改完配置文件后再运行`GymReservation.py`即可启动脚本，其将开启定时任务，期间需保持后台运行（建议在前一晚睡觉前开启，第二天早上7点即可完成自动预约）
8. 大部分预约失败的情况都写在日志中打印输出了，可以尝试自行排查，有问题可以提issue

# 配置参数说明
`header`: 自定义请求头参数，可以存多个账号的cookie，一个账号可以抢一个小时的场地，如果需要抢多个时间段的场地，就需要配置多个账号。（每个账号将对应创建一个任务执行脚本）

`reservation`: (这里是用于配置预约请求参数的，`resource_id=17`代表是羽毛球，不用动)
- `date`: 
- `period`: 时间段id（几点到几点是固定的，只代表时间段，与场地号无关）
- `sub_resource_id`: 具体场次id（同一时间段的不同场地id均不同，因此如需抢多个时间段，需对应调整该值）

**PS：**
因为一个账号每天只能抢一个场次，因此如需抢多个场次，则每个账号需配置对应的场次预约参数
例如：有三个账号，希望在当天预约`1号场地18:00-19:00、2号场地19:00-20:00、2号场地20:00-21:00`这三个场次。
1. 那么date不用改，代码中默认会获取当天日期进行配置，为空都行
2. 第一个period设置为9354，其代表18:00-19:00时间段；第二个period设置为9355，其代表19:00-20:00时间段；第三个period设置为9356，其代表20:00-21:00时间段。（由此可以看出，时间段的id是每个小时递增1）
3. 第一个sub_resource_id设置为28126，其代表`1号场地18:00-19:00`；第二个sub_resource_id设置为28140，其代表`2号场地19:00-20:00`；第三个sub_resource_id设置为28141，其代表`2号场地19:00-20:00`。（可以理解为对应的预约按钮的id，同一场地号下id按小时递增1；同一时间段的相邻场地，其id相差13，因为每天有13个时间段）

`captcha`:
- `username`: 打码网站登录用户名（可以改成自己的）
- `password`: 打码网站登录密码 （可以改成自己的）
- `usertoken`: 打码账户token（经测试发现该字段无效，可以为空，使用`用户名+密码`的方式请求打码验证即可）
- `ID`: 验证码请求模型ID（除非打码网站对应的模型有变动才需要更改）
- `version`: 验证码模型版本（除非打码网站对应的模型有变动才需要更改）

`schedule`:
- `use`: 是否启用定时任务（默认开启）
- `day`: 设置执行任务脚本的日期（默认为null，代表每天都会执行定时任务）
- `time`: 开始执行任务脚本的时间点（因为预约每天早上7点准时开启，晚2秒钟以防系统有延迟）

`retry`: 是否开启失败重试

`max-tries`: 最大重试次数

